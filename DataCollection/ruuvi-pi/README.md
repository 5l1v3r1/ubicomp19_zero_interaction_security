# Data collector comprised of Rapsberry Pi + RuuviTag

This folder contains the codebase used for data collection (temperature, humidity, barometric pressure) for the paper "Perils of Zero-Interaction Security in the Internet of Things", by Mikhail Fomichev, Max Maass, Lars Almon, Alejandro Molina, Matthias Hollick, in Proceedings of the ACM on Interactive, Mobile, Wearable and Ubiquitous Technologies, vol. 3, Issue 1, 2019. 

The setup consists of the following hardware:

* *Raspberry Pi 3 Model B Rev 1.2* with *Raspbian GNU/Linux 9.4 (stretch, 4.14.71-v7+)*
* *RuuviTag* with modified *Firmware v1.3.6.1*

The RuuviTag is NOT physically connected to the Raspberry Pi.

The data collector is used to collect the following sensor modalities:

| **Hardware**      | **Sensors**       | **Sampling rate**  | **Comments** |
| ------------- |:-------------:| -----:|:-----------------------:|
| RuuviTag      | Temperature (°C), humidity (%RH), barometric pressure (hPa) | 10 Hz | The sensor data is broadcasted by the RuuviTag and captured by the Raspberry Pi via BLE  |

## Getting Started

The data collector consists of the following scripts/components:

* *main_ruuvi.sh* - **a main script** to start, maintain and stop the data collection. 
* *~/conf* - a folder containing configuration parameters used by the *main_ruuvi.sh*. The file *~/conf/main_conf.txt* contains 1) the MAC address of the RuuviTag to listen broadcasts from, 2) the duration of the data collection, 3) the date and time to start the data collection (see comments in *~/conf/main_conf.txt* for details). 
* *~/capture_scripts/ruuvi_capture.py* - a script for capturing sensor data from the RuuviTag and logging it on the Raspberry Pi. The script was used with *Python 3.5.3* and the following requirements:
```
psutil==5.4.7
ruuvitag-sensor==0.11.0
```
   

## Deployment

* To deploy the collector on a Raspberry Pi (should also work on the most recent Raspbian) first install necessary libraries with dependencies (see *requirements.txt*). Then copy all the content of the *~/ruuvitag-pi* to */home/pi* on the Raspberry Pi. 
* The RuuviTag should be flashed with *Firmware v1.3.6.1*, which we modified to decrease the tag advertisement interval, thus increasing a sampling rate to 10 Hz. The firmware is modified and loaded as follows (tested with *Ubuntu 17.10 (kernel 4.13.0-46, x86_64)* and *Python 3.6.3*):
    * Install the necessary toolchain and download the firmware (*v1.3.6.1*)—use the [official Git](https://github.com/ruuvi/ruuvitag_fw) for that. **Note:** in our experiments the data collection did NOT work with latest firmware at the time, which was *v2.3.0*—so use version *1.3.6.1*!
    * The firmware is compiled by running ```$ sudo make``` inside ```.../ruuvitag_fw-1.3.6.1```.
    * Change the advertisement interval by setting the variable ```MAIN_LOOP_INTERVAL_RAW``` to ```100u``` in the follwoing file: ```.../ruuvitag_fw-1.3.6.1/ruuvi_examples/ruuvi_firmware/bluetooth_application_config.h```, then recompile the firmware.
    * To create the DFU zip package that is loadable on the RuuviTag grab the compiled firmware (```.../ruuvitag_fw-1.3.6.1/ruuvi_examples/ruuvi_firmware/ruuvitag_b/s132/armgcc/_build/ruuvi_firmware.hex```) and the public private key (```.../ruuvitag_fw-1.3.6.1/keys/ruuvi_open_private.pem```), and drop them to a common folder, e.g., ```.../ruuvi_app```.
    * The DFU zip package is generated by running ```nrfutil pkg generate --debug-mode --application ruuvi_firmware.hex --hw-version 3 --sd-req 0x91 --key-file ruuvi_open_private.pem ruuvi_firmware_dfu.zip``` inside ```.../ruuvi_app```. See more examples [here](https://github.com/ruuvi/ruuvitag_fw#prerequisites-to-create-dfu-distribution-zip-packages). **Note:** [nrfutil](https://github.com/NordicSemiconductor/pc-nrfutil) must be installed separately.
    * Finally the generated DFU zip package is loaded to the RuuviTag, e.g., using [nRF Connect](https://play.google.com/store/apps/details?id=no.nordicsemi.android.mcp), see examples [here](https://lab.ruuvi.com/dfu/). 




**Notes:** 

* The data collection functionality is invoked inside *main_ruuvi.sh*, thus the script should be consulted to see how individual components are called.Also, check the *main_ruuvi.sh* script to see which **other utilities need to be installed**, e.g., the ones used for NTP update, etc.    
* The correctness of *~/conf/main_conf.txt* must be thoroughly checked: if the Raspberry Pi gets an incorrect configuration file it will either shut down (see below) or not data will be recorded from the RuuviTag!
* Since we are using timestamps, the NTP synchronization is mandatory, thus make sure that the Raspberry Pi can access the Internet and use the *ntpdate* to obtain the time update. 

In our experiments we started the *main_ruuvi.sh* from crontab as follows:

```bash
# The crontab file is located at /var/spool/cron/crontabs/root
@reboot /bin/bash /home/pi/main_ruuvi.sh 2>&1 | tee -a /home/pi/out.txt
```
Here, */home/pi/out.txt* is a log file to monitor the data collection process. 

**Caution:** For debugging purposes we introduced the following mechanism: if a critical problem or error occur (*touch /boot/1stexp.txt* in the *main_ruuvi.sh*), the Raspberry Pi will shut down, then we will manually inspect the log file (*/home/pi/out.txt*) to resolve the problem. 
In order not to start the data collection again (because it will destroy old results) we create a watchdog file (*/boot/1stexp.txt*) when a critical error occurs. If this file is created the *main_ruuvi.sh* will always shut down the Raspberry Pi, see the first lines in the script: 


```bash
# Check if we should shutdown
if [ -e /boot/1stexp.txt ]; then
  echo "File exists, exiting..."
  shutdown -P now
  exit 1
fi
```

The data collection runs for the duration specified in *~/conf/main_conf.txt*, after the time is up the Raspberry Pi automatically shuts down. The collected sensor data is stored in the following structure in */home/pi/*:

```
+ MAC-ADDRESS/     # MAC-ADDRESS format: "XX:XX:XX:XX:XX:XX" (capital or lower case)
| + sensors/
| | + barData.txt  # Barometric pressure data
| | + humData.txt  # Humidity data
| | + tmpData.txt  # Temperature data
```

## Authors

Mikhail Fomichev and Max Maass


## License

The code is licensed under the GNU GPLv3 - see [LICENSE.txt](https://dev.seemoo.tu-darmstadt.de/zia/evaluation-public/blob/master/LICENSE.txt) for details
